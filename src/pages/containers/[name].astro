---
import Page from "@/components/page.astro";
import ContainerIcon from "@/assets/icons/lucide--container.svg";
import PlayIcon from "@/assets/icons/lucide--play.svg";
import PauseIcon from "@/assets/icons/lucide--pause.svg";
import Trash2Icon from "@/assets/icons/lucide--trash-2.svg";
import RefreshCwIcon from "@/assets/icons/lucide--refresh-cw.svg";
import SkullIcon from "@/assets/icons/lucide--skull.svg";
import CircleDivideIcon from "@/assets/icons/lucide--circle-divide.svg";
import Button from "@/components/button.astro";
import ProjectCard from "@/components/containers/project-card.astro";
import ImageCard from "@/components/containers/image-card.astro";
import util from "util";

const { name } = Astro.params;
if (!name) {
  return Astro.redirect("/containers");
}

const { host } = Astro.locals;
const container = host.containers.find((container) => container.name === name);
if (!container) {
  return Astro.redirect("/containers");
}
const isStartable = ["created", "exited"].includes(container.state);
const isStoppable = ["running", "paused", "restarting"].includes(container.state);
const isRestartable = ["created", "running", "paused"].includes(container.state);
const isKillable = ["running", "paused", "restarting"].includes(container.state);
const isDeletable = ["created", "exited", "dead"].includes(container.state);
const isPausable = ["running"].includes(container.state);
const isUnpausable = ["paused"].includes(container.state);
const isUppable =
  container.state === "down" && container.project?.dockerComposeFilePath !== undefined;
---

<Page
  title={[{ text: "Containers", href: "/containers" }, { text: container.name }]}
  icon={ContainerIcon}
>
  <div slot="header">
    <Button
      visible={isPausable}
      icon={PauseIcon}
      label="Pause"
      data-id={name}
      data-action="containers.pause"
    />
    <Button
      visible={isUnpausable}
      icon={PlayIcon}
      label="Unpause"
      data-id={name}
      data-action="containers.unpause"
    />
    <Button
      visible={isStoppable}
      icon={CircleDivideIcon}
      label="Stop"
      data-id={name}
      data-action="containers.stop"
      theme="warning"
    />
    <Button
      visible={isUppable}
      icon={PlayIcon}
      label="Start"
      data-id={container.serviceName}
      data-action="projects.up"
      data-path={container.project?.dockerComposeFilePath}
      theme="success"
    />
    <Button
      visible={isStartable}
      icon={PlayIcon}
      label="Start"
      data-id={name}
      data-action="containers.start"
      theme="success"
    />
    <Button
      visible={isRestartable}
      icon={RefreshCwIcon}
      label="Restart"
      data-id={name}
      data-action="containers.restart"
    />
    <Button
      visible={isKillable}
      icon={SkullIcon}
      label="Kill"
      data-id={name}
      data-action="containers.kill"
      theme="danger"
    />
    <Button
      visible={isDeletable}
      icon={Trash2Icon}
      label="Delete"
      data-id={name}
      data-action="containers.delete"
      theme="danger"
    />
  </div>
  {
    container.project && (
      <section>
        <h2>Project</h2>
        <div class="grid">
          <ProjectCard container={container} project={container.project} />
        </div>
      </section>
    )
  }

  {
    container.image && (
      <section>
        <h2>Image</h2>
        <div class="grid">
          <ImageCard image={container.image} />
        </div>
      </section>
    )
  }

  <section>
    <h2>Debug</h2>
    <details>
      <summary>Container</summary>
      <pre>{util.inspect(container, false, 2)}</pre>
    </details>
  </section>
</Page>

<script>
  import { actions } from "astro:actions";

  document.querySelectorAll<HTMLButtonElement>("button[data-action][data-id]").forEach((button) => {
    button.addEventListener("click", async () => {
      const { action, id, path } = button.dataset;
      if (!action || !id) {
        return;
      }

      switch (action) {
        case "containers.start":
          await actions.containers.start({ id });
          window.location.reload();
          break;
        case "containers.stop":
          await actions.containers.stop({ id });
          window.location.reload();
          break;
        case "containers.restart":
          await actions.containers.restart({ id });
          window.location.reload();
          break;
        case "containers.kill":
          await actions.containers.kill({ id });
          window.location.reload();
          break;
        case "containers.pause":
          await actions.containers.pause({ id });
          window.location.reload();
          break;
        case "containers.unpause":
          await actions.containers.unpause({ id });
          window.location.reload();
          break;
        case "containers.delete":
          const result = await actions.containers.delete({ id });
          if (!result.error) {
            window.location.href = "/containers";
          }
          break;
        case "projects.up":
          if (!path) return;
          await actions.projects.up({ path, service: id });
          window.location.reload();
          break;
        default:
          break;
      }
    });
  });
</script>

<style>
  div {
    display: flex;
    gap: 8px;
  }

  section {
    margin-block: 3em;
    & > h2 {
      margin-bottom: 1em;
    }

    & > .grid {
      display: flex;
      flex-wrap: wrap;
      align-items: flex-start;
      gap: 16px;
    }
  }
</style>
